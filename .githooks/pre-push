#!/usr/bin/env bash
set -euo pipefail

OUTPUT_ROOT="output/notes"

echo "[pre-push] Building site with local Forester before push..."

npm run build

if [ ! -d "$OUTPUT_ROOT" ] || [ -z "$(ls -A "$OUTPUT_ROOT")" ]; then
  echo "[pre-push] Forester build did not produce the output/notes directory." >&2
  exit 1
fi

if [ ! -f "$OUTPUT_ROOT/index.html" ]; then
  echo "[pre-push] output/notes/index.html missing after build; stopping push." >&2
  exit 1
fi

# Keep hook fast by skipping push if build left unstaged changes.
if ! git diff --quiet -- "$OUTPUT_ROOT"; then
  echo "[pre-push] output/notes has changes. Stage/commit them before pushing." >&2
  exit 1
fi
